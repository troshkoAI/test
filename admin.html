<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tro≈°ko Potro≈°ko - Admin Panel</title>
    <!-- We only need the base Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none; }
        select, button { font-size: 16px; padding: 10px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { cursor: pointer; }
        .btn-danger { background-color: #e74c3c; color: white; border-color: #c0392b; }
        .btn-danger:hover { background-color: #c0392b; }
    </style>
</head>
<body>

    <div id="loading-container" class="container">
        <h1>Loading Admin Panel...</h1>
        <p>Please wait.</p>
    </div>

    <div id="admin-container" class="container hidden">
        <h1>üëë Admin Panel</h1>
        <div id="user-info"></div>
        <hr style="margin: 20px 0;">
        <div>
            <label for="householdSwitcher" style="display:block; margin-bottom: 5px;"><strong>Manage Household:</strong></label>
            <select id="householdSwitcher"></select>
        </div>
        <div>
            <button id="deleteHouseholdBtn" class="btn-danger hidden">üóëÔ∏è Delete Selected Household</button>
        </div>
    </div>
    
    <div id="access-denied-container" class="container hidden">
        <h1>Access Denied</h1>
        <p>You do not have permission to view this page.</p>
        <a href="/">Go to main application</a>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyADHFkhDpff4OFLfxb5WF3yzgq7DfYIeic", // From your original file
            authDomain: "troshkopotroshko.firebaseapp.com",
            projectId: "troshkopotroshko",
            storageBucket: "troshkopotroshko.firebasestorage.app",
            messagingSenderId: "618260255495",
            appId: "1:618260255495:web:7ec7ebff552859d7c12ba2",
            measurementId: "G-94W10KXPSD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        let allHouseholds = [];
        let selectedHouseholdId = null;

        // The entry point for the admin page
        auth.onAuthStateChanged(async user => {
            if (user) {
                // User is signed in, now verify if they are an admin.
                const userDoc = await firestore.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'admin') {
                    // User is an admin, proceed to load the panel.
                    document.getElementById('loading-container').classList.add('hidden');
                    document.getElementById('admin-container').classList.remove('hidden');
                    document.getElementById('user-info').innerHTML = `<p>Logged in as: <strong>${user.email}</strong></p>`;
                    await loadAdminData();
                } else {
                    // User is NOT an admin, show access denied message.
                    document.getElementById('loading-container').classList.add('hidden');
                    document.getElementById('access-denied-container').classList.remove('hidden');
                }
            } else {
                // User is not signed in, redirect to main page to log in.
                window.location.href = '/';
            }
        });

        async function loadAdminData() {
            const switcher = document.getElementById('householdSwitcher');
            switcher.innerHTML = '<option value="">-- Select a household --</option>';
            
            try {
                const snapshot = await firestore.collection('groups').orderBy('name').get();
                allHouseholds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                allHouseholds.forEach(hh => {
                    const memberCount = hh.members ? hh.members.length : 0;
                    switcher.add(new Option(`${hh.name} (${memberCount} members)`, hh.id));
                });
            } catch (error) {
                alert("Failed to load households. Ensure admin role is set correctly in Firestore and check console.");
                console.error("Error loading households:", error);
            }
        }
        
        document.getElementById('householdSwitcher').addEventListener('change', (e) => {
            selectedHouseholdId = e.target.value;
            document.getElementById('deleteHouseholdBtn').classList.toggle('hidden', !selectedHouseholdId);
        });

        document.getElementById('deleteHouseholdBtn').addEventListener('click', async () => {
            if (!selectedHouseholdId) {
                alert("No household selected.");
                return;
            }
            
            const householdToDelete = allHouseholds.find(h => h.id === selectedHouseholdId);
            if (!householdToDelete) return;

            const confirmation = confirm(`ARE YOU SURE you want to permanently delete the household "${householdToDelete.name}" and all of its data? This cannot be undone.`);
            if (!confirmation) return;

            try {
                await firestore.collection('groups').doc(selectedHouseholdId).delete();
                alert(`Household "${householdToDelete.name}" has been deleted successfully.`);
                // Reload the page to refresh the list
                window.location.reload();
            } catch (error) {
                console.error("Error deleting household:", error);
                alert("Failed to delete household. See console for details.");
            }
        });

    </script>
</body>
</html>